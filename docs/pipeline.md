# PII detection and anonymization flow

Этот сервер строится вокруг Presidio и spaCy. Ниже описаны основные шаги, которые выполняются от входящего запроса до выдачи результата.

## Инициализация (ленивая)
1. **NLP-движок:** при первом обращении создаётся `NlpEngine` по конфигу spaCy (`ru_core_news_lg`, `en_core_web_lg`). При ошибке загрузки включается fallback с минимальным пайплайном и выставляются флаги статуса (`initialized`, `fallback_used`, `reason`).
2. **Реестр распознавателей:** далее инициализируется `RecognizerRegistry`, в который загружаются предустановленные recognizer’ы Presidio и кастомные паттерны для российских документов и банковских реквизитов.
3. **Analyzer/Anonymizer:** поверх реестра создаются `AnalyzerEngine` (поддерживает `ru` и `en`) и `AnonymizerEngine`. Все объекты кешируются в модулях и создаются только один раз за процесс.

## Обработка запроса `/analyze`
1. **Определение языка:** `detect_language` выбирает `ru` или `en` (явный параметр, fastText, `langdetect`, эвристика по кириллице).
2. **Анализ:** `AnalyzerEngine.analyze` запускает spaCy + набор recognizer’ов и выдаёт черновые `RecognizerResult` с типом сущности, позициями и score.
3. **Пост-валидация:** `post_validate` фильтрует результаты: отсеивает низкие score для ML-сущностей, проверяет контрольные суммы (карты, СНИЛС, ИНН, ОГРН/ОГРНИП), валидирует паспорт и связку банковского счёта с найденным БИК, убирает дубликаты.
4. **Ответ:** для каждой сущности возвращаются `entity_type`, `start`, `end`, исходный `text` и `score`.

## Обработка запроса `/anonymize`
1. Шаги 1–3 аналогичны `/analyze`.
2. **Политика:** берётся дефолтная политика замены и поверх неё накладывается пользовательская (если есть), затем переводится в `OperatorConfig`.
3. **Анонимизация:** `AnonymizerEngine.anonymize` применяет оператор к каждому результату анализа и возвращает анонимизированный текст плюс список исходных сущностей (в том же формате, что и `/analyze`).

## Статус
Эндпоинт `/health` отдаёт информацию об инициализации и использовании fallback для spaCy/NLP. Это помогает понять, работаем ли мы на полноценной модели или в деградированном режиме.
